@using System.Text.Json
@inject HttpClient Http

@if (result == null)
{
    <p>Running backtestâ€¦</p>
}
else
{
    <div class="summary">
        <p><strong>Total Trades:</strong> @result.TotalTrades</p>
        <p><strong>Wins:</strong> @result.Wins</p>
        <p><strong>Losses:</strong> @result.Losses</p>
        <p><strong>Win Rate:</strong> @($"{result.WinRate:P2}")</p>
        <p><strong>Total Profit:</strong> @($"{result.TotalProfit:F2}")</p>
        <p><strong>Max Drawdown:</strong> @($"{result.MaxDrawdown:F2}")</p>
    </div>

    <h4>Trade History</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Time</th>
                <th>Pattern</th>
                <th>Direction</th>
                <th>Entry</th>
                <th>Exit</th>
                <th>Outcome</th>
                <th>Profit</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var trade in result.Trades)
            {
                <tr>
                    <td>@trade.Time.ToString("g")</td>
                    <td>@trade.PatternType</td>
                    <td>@trade.Direction</td>
                    <td>@trade.Entry</td>
                    <td>@trade.Exit</td>
                    <td>@trade.Outcome</td>
                    <td>@($"{trade.Profit:F2}")</td>
                    <td>@trade.Duration</td>
                </tr>
            }
        </tbody>
    </table>

    <h4>Equity Curve</h4>
}
@code {
    [Parameter]
    public DateTime Start { get; set; }

    [Parameter]
    public DateTime End { get; set; }

    [Parameter]
    public StrategyConfig Config { get; set; } = new();

    private BacktestResult? result;

    protected override async Task OnInitializedAsync()
    {
        var request = new BacktestRequest
        {
            Start = Start,
            End = End,
            Config = Config
        };

        try
        {
            var response = await Http.PostAsJsonAsync($"{Stat.Url}/backtest/run", request);

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();

                if (!string.IsNullOrWhiteSpace(content))
                {
                    result = JsonSerializer.Deserialize<BacktestResult>(content, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                }
                else
                {
                    Console.WriteLine("Response body was empty.");
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"API error: {response.StatusCode}, Body: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ðŸ’¥ Exception during backtest: {ex.Message}");
        }
    }

}